!function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=2)}([function(e,t){e.exports=_},function(e,t){e.exports=angular},function(e,t,s){"use strict";s.r(t);var i=s(0);let r;!function(e){e.Outcome="outcome",e.Poll="poll",e.Score="score",e.Survey="survey",e.Live="live"}(r||(r={}));var n=s(1);var a=s.n(n).a.module("4screens.engageform",["4screens.util.cloudinary","LocalStorageModule"]);let o,l,h,g,u;!function(e){e.Undefined="undefined",e.Default="default",e.Preview="preview",e.Result="results",e.Summary="summary"}(o||(o={})),function(e){e[e.Undefined=0]="Undefined",e[e.Live=1]="Live",e[e.Outcome=2]="Outcome",e[e.Poll=3]="Poll",e[e.Score=4]="Score",e[e.Survey=5]="Survey"}(l||(l={})),function(e){e.Default="default",e.Entry="entry",e.Exit="exit"}(h||(h={})),function(e){e.And="and",e.Or="or"}(g||(g={})),function(e){e.Equal="eq",e.NotEqual="neq",e.Blank="blank",e.NotBlank="nblank",e.GreaterThan="gt",e.GreaterThanOrEqual="gte",e.LessThan="lt",e.LessThanOrEqual="lte",e.Between="between",e.Contain="contain",e.NotContain="ncontain"}(u||(u={}));const c=e=>e.type===h.Entry,d=e=>e.type===h.Exit,m=e=>e.type===h.Default,f=e=>Boolean(e.field);function p(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class b{static fromEnageform(e){return new b(e)}constructor(e){p(this,"_engageform",void 0),p(this,"visitedPages",[]),p(this,"enabled",!1),p(this,"position",0),p(this,"size",0),p(this,"hasStart",!1),p(this,"enabledStart",!0),p(this,"hasPrev",!1),p(this,"enabledPrev",!0),p(this,"hasNext",!1),p(this,"enabledNext",!0),p(this,"hasFinish",!1),p(this,"enabledFinish",!0),p(this,"distance",0),p(this,"animate","swipeNext"),p(this,"hasStartPages",!1),p(this,"hasEndPages",!1),p(this,"waitingForPageChange",null),p(this,"next",this.pick),p(this,"finish",this.pick),this._engageform=e,this.size=e.availablePages.length,this.hasEndPages=Boolean(e.endPages.length),e.startPages.length?(this.hasStart=!0,this.hasStartPages=!0,this._engageform.setCurrent(e.startPages[0])):(this.enabled=!0,this.move(),this.hasPrev=!1)}updateDistance(){return this.distance=this.position/this.size}start(e){this.disableDefaultAction(e),this.animate="swipeNext",this.enabled=!0,this.hasStart=!1,this.move(),this.hasPrev=!0}stopPageChange(){this.waitingForPageChange&&me.$timeout.cancel(this.waitingForPageChange)}prev(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.disableDefaultAction(e),this.stopPageChange(),this.animate="swipePrev",this._engageform.current&&(this._engageform.message=""),this.position-=t,this.updateDistance(),this.hasNext=!0,this.hasFinish=!1,0===this.position?(this._engageform.setCurrent(this._engageform.startPages[0]),this.hasPrev=!1):(this._engageform.setCurrent(this._engageform.availablePages[this.position-1]),this.hasPrev=1!==this.position||this.hasStartPages)}pick(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{quiet:!1};if(this.disableDefaultAction(e),this.stopPageChange(),this.animate="swipeNext",!this._engageform.isNormalMode()){let e=me.$q.defer();return e.resolve(t),this.move(t),e.promise}let i=this._engageform.current;return!t||!this._engageform.settings.allowAnswerChange&&i.filled||(t.selected=!0,t.incorrect=!1),i.send(t).then(()=>{if(this.sendMessage(),!i.filled&&i.settings.requiredAnswer)return s.quiet||this.sendMessage(this._engageform.texts.ANSWER_REQUIRED_TO_PROCEED),t;{let e=t?i.settings.showCorrectAnswer||i.settings.showResults?1e3:200:0;return this.waitingForPageChange=me.$timeout(()=>(this.waitingForPageChange=null,this.move(t),t),e),this.waitingForPageChange}}).catch(e=>(s.quiet||this.sendMessage(this._engageform.texts[e.textKey]||e.message),e))}move(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._engageform.event.trigger("form::pageWillChange",{isStartPage:Boolean(0===this.position&&this._engageform.startPages.length)}),this.visitedPages.push(this._engageform.current),this.position+=t,this._engageform.availablePages.length>=this.position?(this.updateDistance(),this._engageform.setCurrent(this._engageform.availablePages[this.position-1]),this.hasPrev=!0,this.hasNext=!1,this.hasFinish=!1,this._engageform.availablePages.length>this.position?this.hasNext=!0:this._engageform.availablePages.length===this.position&&(this.hasFinish=this._engageform.isNormalMode()&&!(this._engageform.isType(l.Poll)&&!this._engageform.hasForms)),this._engageform.event.trigger("form::pageDidChange",{currentPosition:this.position,isEndPage:!1})):(this.position=this._engageform.availablePages.length,e||this._engageform.setCurrentEndPage().then(e=>{this._engageform.type!==l.Score&&this._engageform.type!==l.Outcome||this._engageform.event.trigger("finish",e.totalScore||e.outcome,e.maxScore),this.enabled=!1,this.hasPrev=!1,this.hasNext=!1,this.hasFinish=!1,this._engageform.event.trigger("form::pageDidChange",{currentPosition:this.position,isEndPage:!0})}).catch(e=>{e.data.msg&&this.sendMessage(e.data.msg)}))}disableDefaultAction(e){e&&(e.stopPropagation(),e.preventDefault())}sendMessage(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this._engageform.message=e,me.$timeout(()=>{this._engageform.message=""},this._engageform.settings.hideMessageAfterDelay)}}let v,w;function P(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}!function(e){e[e.Undefined=0]="Undefined",e.EndPage="endPage",e.Form="forms",e.MultiChoice="multiChoice",e.PictureChoice="pictureChoice",e.Rateit="rateIt",e.StartPage="startPage",e.Poster="poster",e.SummaryPage="summaryPage"}(v||(v={}));class y{constructor(e,t){this.logic=e,this.answers=t,P(this,"entryRules",this.logic.rules.filter(c)),P(this,"exitRules",this.logic.rules.filter(d)),P(this,"defaultRule",Object(i.head)(this.logic.rules.filter(m)))}hasEntryRules(){return this.entryRules.length>0}hasExitRules(){return this.exitRules.length>0}resolveEntryDestination(){return this.resolveDestination(this.entryRules)}resolveExitDestination(){return this.resolveDestination(this.exitRules)}resolveDestination(e){return e.map(e=>{let t=e.destination,s=e.conditionsConnection;return e.conditions.map(e=>{let t=this.answers.get(e.to);if(!t)return!1;switch(f(e)&&(t=t[e.field]),e.is){case u.Equal:return t===e.value;case u.NotEqual:return t!==e.value;case u.GreaterThan:return t>e.value;case u.GreaterThanOrEqual:return t>=e.value;case u.LessThan:return t<e.value;case u.LessThanOrEqual:return t<=e.value;case u.Between:return e.value[0]>=t&&t<=e.value[1];case u.Blank:return!Boolean(t);case u.NotBlank:return Boolean(t);case u.Contain:return t.indexOf(e.value)>=0;case u.NotContain:return-1===t.indexOf(e.value);default:return!1}})[s===g.Or?"some":"every"](e=>e)?t:null}).filter(Boolean)[0]||this.defaultRule.destination}}class C extends b{static fromEnageformAndData(e,t){return new C(e,t)}constructor(e,t){super(e),P(this,"logic",{}),(JSON.parse(t._logic)||[]).forEach(e=>{this.logic[e.questionId]=new y(e,this._engageform.answers)})}prev(e){const t=this.visitedPages.pop(),s=this._engageform.getPageIndex(this._engageform.current)-this._engageform.getPageIndex(t);super.prev(e,s)}move(e){const t=this._engageform.current,s=this.logic[t.id];let i,r;return(r=this.isPossiblyConditionalPage(t)?s&&s.hasExitRules()?this._engageform.getPageById(s.resolveExitDestination()):this._engageform.getPageByIndex(this.position+1):this._engageform.getPageByIndex(0))&&(r=this.checkEntryConditionForPage(r)),r&&(i=this._engageform.getPageIndex(r)-this._engageform.getPageIndex(t)),super.move(e,i)}checkEntryConditionForPage(e){const t=this.logic[e.id];if(t&&t.hasEntryRules()){const e=t.resolveEntryDestination(),s=this._engageform.getPageById(e);return s?this.checkEntryConditionForPage(s):s}return e}isPossiblyConditionalPage(e){return[v.Form,v.MultiChoice,v.PictureChoice,v.Rateit].includes(e.type)}}function _(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class I{static create(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new I(e,I.arePropertiesCustom(e))}static arePropertiesCustom(e){let t=e.text,s=e.link,i=e.imageUrl;return Boolean(I.isTextCustom(t)||s||I.isImageCustom(i))}static isTextCustom(e){return void 0!==e}static isImageCustom(e){return void 0!==e&&e!==I.defaultBranding.imageUrl}static get defaultBranding(){return me.getConfig("backend").branding}get isCustom(){return this._custom}get isDefault(){return!this._custom}get isCustomLogo(){return this._isCustomLogo}get imageUrl(){return this._imageUrl}get link(){return this._link}get text(){return this._text}get enabled(){return this._enabled}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.state,s=e.text,i=e.link,r=e.imageUrl,n=arguments.length>1?arguments[1]:void 0;_(this,"_text",void 0),_(this,"_link",void 0),_(this,"_imageUrl",void 0),_(this,"_isCustomLogo",!1),_(this,"_enabled",void 0),_(this,"_custom",void 0),this._custom=n,this._enabled=!t,this._text=I.isTextCustom(s)?s:I.defaultBranding.text,this._link=i||I.defaultBranding.link,I.isImageCustom(r)?(this._imageUrl=r?`${me.getConfig("backend").api+me.getConfig("backend").imagesUrl}/${r}`:"",this._isCustomLogo=!0):this._imageUrl=me.config.backend.api+r}}class x{constructor(){var e,t,s;s={},(t="_listener")in(e=this)?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}listen(e,t){this._listener[e]||(this._listener[e]=[]),this._listener[e].push(t)}trigger(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];const r=this._listener[e];r&&r.forEach(e=>e.apply(e,s))}}function k(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class O{static fromEngageform(e){return new O(e)}constructor(e){let t=e.settings.share,s=e.endPages,r=e.startPages,n=e.pages;k(this,"globalTitle",void 0),k(this,"globalDescription",void 0),this.globalTitle="",this.globalDescription="",t&&(this.globalTitle=t.title||"",this.globalDescription=t.description||""),(s.length<1||!Object(i.find)(n,{social:!0}))&&r.length&&n[r[0]].title&&(this.globalTitle=n[r[0]].title,this.globalDescription=n[r[0]].description)}}function S(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class A{constructor(e){S(this,"showResults",!1),S(this,"showCorrectAnswer",!1),S(this,"showMainMedia",!1),S(this,"showDescription",!1),S(this,"requiredAnswer",!1),this.requiredAnswer=!!e.requiredAnswer,e.settings&&(this.showResults=!!e.settings.showAnswers,this.showCorrectAnswer=!!e.settings.showCorrectAnswer,this.showMainMedia=!!e.settings.showMainMedia,this.showDescription=!!e.settings.showDescription)}}function D(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class E{constructor(e,t){D(this,"id",void 0),D(this,"engageform",void 0),D(this,"type",v.Undefined),D(this,"title",""),D(this,"description",""),D(this,"media",""),D(this,"mediaWidth",0),D(this,"mediaHeight",0),D(this,"filled",!1),D(this,"settings",void 0),D(this,"cases",[]),D(this,"result",void 0),this.id=t._id,this.engageform=e,this.settings=new A(t),this.title=t.text||"",this.settings.showDescription&&(this.description=t.description||""),this.settings.showMainMedia&&t.imageData&&(this.media=me.cloudinary.prepareImageUrl(t.imageFile,680,t.imageData),this.mediaWidth=680,t.imageData.containerRatio?this.mediaHeight=Math.round(680*t.imageData.containerRatio):this.mediaHeight=Math.round(t.imageData.containerHeight||0))}send(e){if(!1===this.engageform.enabled)return me.$q.reject("Engageform already ended.");if(e)return e.send();{let e=me.$q.defer();return e.resolve(),e.promise}}sent(){const e=me.$q.defer();let t={};return t=me.localStorage.get("page."+this.id)||{},this.engageform.setAnswer(this.id,t),this.settings.showResults&&t.results?this.getStatsById(this.id).then(s=>{e.resolve(this.refreshAnswer(t,s))}).catch(()=>{e.resolve(t)}):e.resolve(t),e.promise}refreshAnswer(e,t){return e}selectAnswer(e){}createCase(e,t){}setResults(e){let t=this.cases.map(t=>(t.result=Number(e.stats&&e.stats[t.id])||0,t.id));for(let s in e.stats)if(-1===t.indexOf(s)&&"questionId"!==s&&this.type!==v.Rateit){let t=this.createCase({text:"[Removed answer]",_id:s,imageData:{height:100}});t.result=Number(e.stats[t.id]),this.cases.push(t)}}updateAnswers(e){this.id===e.questionId&&(this.engageform.current&&!Object(i.isUndefined)(e.avg)&&(this.engageform.current.result=e.avg),me.$timeout(()=>{this.cases.map(t=>{if(!Object(i.isUndefined)(e[t.id])){const s=t.load();s.results&&(s.results[t.id]=e[t.id],t.save(s)),t.result=e[t.id]||0}})}))}getStatsById(e){let t=me.config.backend.domain+me.getConfig("engageform").pageStatsUrl;return t=t.replace(":pageId",e),me.$http.get(t).then(e=>-1!==[200,304].indexOf(e.status)?e.data:me.$q.reject(e))}}function T(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}D(E,"Type",v);class j extends E{constructor(e,t,s){super(e,t),T(this,"type",v.EndPage),T(this,"isCoverPage",!0),T(this,"button",void 0),T(this,"outcome",void 0),T(this,"social",void 0),T(this,"score",void 0),T(this,"rangeMin",void 0),T(this,"rangeMax",void 0),T(this,"exitLink",void 0),T(this,"link",void 0),T(this,"socialData",void 0);const r=Object(i.defaults)({},s.share,{title:"",description:"",link:"",imageUrl:""});r.imageUrl&&(r.imageUrl=me.cloudinary.preparePreviewImageUrl(r.imageUrl,680)),this.socialData=r,t.coverPage&&(this.button=t.coverPage.buttonText,this.outcome=t.coverPage.outcome,this.social=t.coverPage.showSocialShares,this.exitLink=t.coverPage.exitLink,this.link=t.coverPage.link,t.coverPage.scoreRange&&(this.rangeMax=t.coverPage.scoreRange.max,this.rangeMin=t.coverPage.scoreRange.min))}personalizeShares(){"outcome"!==this.engageform.typeName&&"score"!==this.engageform.typeName||(this.socialData.title=this.engageform.texts.SCORE_AND_OUTCOME_SHARE.replace(/\$RESULT\$/gi,this.outcome||String(this.score||0)).replace(/\$TITLE\$/gi,this.engageform.title),this.media&&this.settings.showMainMedia&&(this.socialData.imageUrl=this.media))}get fbLink(){return me.getConfig("backend")&&me.getConfig("backend").domain&&me.getConfig("share")&&me.getConfig("share").facebook&&this.socialData&&this.socialData.title&&this.socialData.description&&this.socialData.imageUrl&&this.engageform&&this.engageform.id?(this.personalizeShares(),me.getConfig("backend").domain+me.getConfig("share").facebook+"?quizId="+this.engageform.id+"&description="+encodeURIComponent(this.socialData.description)+"&name="+encodeURIComponent(this.socialData.title)+"&image="+this.socialData.imageUrl):null}get twLink(){return this.socialData&&this.socialData.title&&this.socialData.link?(this.personalizeShares(),"https://twitter.com/intent/tweet?text="+encodeURIComponent(this.socialData.title)+" "+this.socialData.link+" via @4screens"):null}}function q(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}!function(e){e[e.Undefined=0]="Undefined",e[e.Image=1]="Image",e[e.Input=2]="Input",e[e.Iteration=3]="Iteration",e[e.Text=4]="Text"}(w||(w={}));class R{constructor(e,t){let s=t._id;this.page=e,q(this,"id",void 0),q(this,"type",w.Undefined),q(this,"selected",!1),q(this,"correct",!1),q(this,"incorrect",!1),q(this,"result",0),q(this,"title",void 0),q(this,"error",void 0),q(this,"value",void 0),this.id=s}shouldShowIndicator(){return!this.page.engageform.isSummaryMode()&&!this.page.engageform.isResultsMode()&&this.page.settings.showCorrectAnswer&&(this.selected||this.page.filled&&this.correct)}shouldShowResults(){return this.page.engageform.isSummaryMode()||this.page.settings.showResults&&this.page.filled&&!this.page.engageform.isResultsMode()}send(){const e=me.$q.defer();return e.resolve({}),e.promise}makeSend(e){let t=me.getConfig("backend").domain+me.getConfig("engageform").pageResponseUrl;t=t.replace(":pageId",this.page.id),me.mode!==o.Default&&(t+="?preview"),e.quizQuestionId=this.page.id,e.userIdent=me.user.sessionId;const s={questionId:this.page.id,questionTitle:this.page.title,answerId:this.id,answerValue:e.inputs&&e.inputs.map(e=>e.value)||this.title||this.ordinal};return me.$http.post(t,e).then(t=>-1!==[200,304].indexOf(t.status)?(!e.userIdent&&t.data.userIdent&&(me.user.sessionId=t.data.userIdent),this.page.engageform.event.trigger("answer",s),t.data):me.$q.reject(t.data||{})).catch(e=>me.$q.reject(e.data||{}))}load(){return me.localStorage.get("page."+this.page.id)||{}}save(e){this.page.engageform.setAnswer(this.page.id,e),me.localStorage.set("page."+this.page.id,e)}validate(){return!0}}function U(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class M extends R{constructor(e,t){super(e,t),U(this,"type",w.Input),U(this,"expectedValue",void 0),U(this,"value",""),this.title=t.label,this.expectedValue=t.type}send(){const e={inputs:[]},t=this.load();for(const s in t)t.hasOwnProperty(s)&&e.inputs.push({_id:s,value:t[s]});return super.makeSend(e).then(()=>e).catch(e=>(406===e.code&&(e.textKey="INCORRECT_INPUT",e.message="Incorrect inputs sent. Try again.",this.save({})),me.$q.reject(e)))}validate(){if(this.correct=!1,this.incorrect=!1,this.page.settings.requiredAnswer&&!this.value?(this.error="Answer is required",this.incorrect=!0):(this.error="",this.correct=!0),this.correct){const e=this.load();return e[this.id]=this.value,this.save(e),!0}return!1}}function B(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class $ extends E{constructor(e,t){super(e,t),B(this,"type",v.Form),B(this,"count",0),t.forms&&(this.cases=t.forms.inputs.map(e=>this.createCase(e)),this.cases.length&&this.sent().then(e=>{this.selectAnswer(e)}))}createCase(e){return new M(this,e)}send(e){var t=me.$q.defer(),s=!0;return this.cases.map(e=>{e.validate()||(s=!1)}),s?(this.filled=!0,this.engageform.sendAnswerCallback(this.engageform.title||this.engageform.id,this.engageform.current?this.engageform.current.title||this.engageform.current.id:null,this.cases[0]),t.resolve(this.cases[0].send())):(this.filled=!1,t.resolve({})),t.promise}selectAnswer(e){this.cases.map(t=>{t.value=e[t.id]||"",e.inputs&&e.inputs.forEach(e=>{e._id===t.id&&(t.value=e.value)})})}setResults(e){this.count=e.count||0}}class F extends R{constructor(e,t){var s,i,r;super(e,t),s=this,i="type",r=w.Text,i in s?Object.defineProperty(s,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[i]=r,this.title=t.text}send(){return!this.page.engageform.settings.allowAnswerChange&&this.page.filled?me.$q.reject({textKey:"CHANGING_NOT_ALLOWED",message:"Changing answer is not allowed"}):super.makeSend({selectedAnswerId:this.id}).then(e=>{const t={};e.selectedAnswerId&&(t.selectedCaseId=e.selectedAnswerId),e.correctAnswerId&&(t.correctCaseId=e.correctAnswerId);for(const s in e.stats)e.stats.hasOwnProperty(s)&&(t.results=t.results||{},/.{24}/.test(s)&&(t.results[s]=e.stats[s]));return super.save(t),this.page.selectAnswer(t),t})}}class N extends E{constructor(e,t){var s,i,r;super(e,t),s=this,i="type",r=v.MultiChoice,i in s?Object.defineProperty(s,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[i]=r,t.answers&&(this.cases=t.answers.map(e=>this.createCase(e)),this.cases.length&&this.sent().then(e=>{this.selectAnswer(e)}))}createCase(e){return new F(this,e)}refreshAnswer(e,t){return t.answers.map(t=>{e.results&&(e.results[t._id]=t.percent)}),e}selectAnswer(e){this.cases.map(t=>{t.selected=!1,t.correct=!1,t.incorrect=!1,t.id===e.selectedCaseId&&(this.engageform.sendAnswerCallback(this.engageform.title||this.engageform.id,this.engageform.current?this.engageform.current.title||this.engageform.current.id:null,t),this.filled=!0,t.selected=!0),e.results&&(t.result=e.results[t.id]||0),t.id===e.correctCaseId?t.correct=!0:t.incorrect=!0})}}function L(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class V extends R{constructor(e,t){super(e,t),L(this,"type",w.Image),L(this,"media",void 0),L(this,"mediaWidth",void 0),L(this,"mediaHeight",void 0),this.title=t.text,this.media=me.cloudinary.prepareImageUrl(t.imageFile,V.mediaWidth,t.imageData),this.mediaWidth=V.mediaWidth,t.imageData&&t.imageData.containerRatio?this.mediaHeight=Math.round(V.mediaWidth*t.imageData.containerRatio):this.mediaHeight=Math.round(t.imageData.containerHeight||0)}send(){return!this.page.engageform.settings.allowAnswerChange&&this.page.filled?me.$q.reject({textKey:"CHANGING_NOT_ALLOWED",message:"Changing answer is not allowed"}):super.makeSend({selectedAnswerId:this.id}).then(e=>{const t={selectedCaseId:e.selectedAnswerId,correctCaseId:e.correctAnswerId};for(const s in e.stats)e.stats.hasOwnProperty(s)&&(t.results=t.results||{},/.{24}/.test(s)&&(t.results[s]=e.stats[s]));return super.save(t),this.page.selectAnswer(t),t})}}L(V,"mediaWidth",300);class z extends E{constructor(e,t){var s,i,r;super(e,t),s=this,i="type",r=v.PictureChoice,i in s?Object.defineProperty(s,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[i]=r,t.answers&&(this.cases=t.answers.map(e=>this.createCase(e)),this.cases.length&&this.sent().then(e=>{this.selectAnswer(e)}))}createCase(e){return new V(this,e)}refreshAnswer(e,t){return t.answers.map(t=>{e.results&&(e.results[t._id]=t.percent)}),e}selectAnswer(e){this.cases.map(t=>{t.selected=!1,t.correct=!1,t.incorrect=!1,t.id===e.selectedCaseId&&(this.engageform.sendAnswerCallback(this.engageform.title||this.engageform.id,this.engageform.current?this.engageform.current.title||this.engageform.current.id:null,t),this.filled=!0,t.selected=!0),e.results&&(t.result=e.results[t.id]||0),t.id===e.correctCaseId?t.correct=!0:t.incorrect=!0})}}function W(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class H extends E{constructor(e,t){super(e,t),W(this,"type",v.Poster),W(this,"button",void 0),W(this,"exitLink",void 0),W(this,"link",void 0),t.coverPage&&(this.button=t.coverPage.buttonText,this.exitLink=t.coverPage.exitLink,this.link=t.coverPage.link)}}function G(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class K extends R{constructor(e,t){super(e,function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{},i=Object.keys(s);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(s).filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable}))),i.forEach(function(t){G(e,t,s[t])})}return e}({},t,{_id:""})),G(this,"type",w.Iteration),G(this,"symbol",void 0),G(this,"ordinal",void 0),this.ordinal=t.ordinal,this.symbol=t.symbol}send(){return!this.page.engageform.settings.allowAnswerChange&&this.page.filled?me.$q.reject({textKey:"CHANGING_NOT_ALLOWED",message:"Changing answer is not allowed"}):super.makeSend({quizQuestionId:this.page.id,rateItValue:this.ordinal}).then(e=>{const t={};return e.selectedValue&&(t.selectedValue=e.selectedValue),e.avgRateItValue&&(t.result=+e.avgRateItValue),super.save(t),this.page.selectAnswer(t),t})}}function Q(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class J extends E{shouldShowResults(){return this.settings.showResults&&this.result>0}constructor(e,t){super(e,t),Q(this,"type",v.Rateit),Q(this,"result",0),Q(this,"labelMin",void 0),Q(this,"labelMax",void 0),Q(this,"selectedValue",0),this.labelMin=t.rateIt.minLabel,this.labelMax=t.rateIt.maxLabel,this.cases=Array.apply(null,Array(t.rateIt.maxRateItValue)).map((e,s)=>this.createCase(s+1,t.rateIt.rateType)),this.sent().then(e=>{e.selectedValue&&(this.selectedValue=e.selectedValue,this.selectAnswer(e))})}createCase(e,t){return new K(this,{ordinal:e,symbol:t})}selectAnswer(e){e.selectedValue&&(this.filled=!0,this.selectedValue=e.selectedValue),e.result&&(this.result=e.result),this.cases.map(t=>{t.selected=e.selectedValue>=t.ordinal,e.selectedValue===t.ordinal&&this.engageform.sendAnswerCallback(this.engageform.title||this.engageform.id,this.engageform.current?this.engageform.current.title||this.engageform.current.id:null,t)})}setResults(e){this.result=e.average||0,this.selectedValue=e.average||0}}function X(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class Y extends E{constructor(e,t){super(e,t),X(this,"type",v.StartPage),X(this,"isCoverPage",!0),X(this,"button",void 0),t.coverPage&&void 0!==t.coverPage.buttonText&&(this.button=t.coverPage.buttonText)}}function Z(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class ee extends E{constructor(e,t){super(e,t),Z(this,"type",v.SummaryPage),Z(this,"stats",void 0),t.text?this.title=t.text:e.type===l.Outcome?this.title="Outcomes":this.title="Scores",this.stats=t.stats}}function te(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class se{constructor(e){te(this,"allowAnswerChange",!1),te(this,"hideMessageAfterDelay",3e3),te(this,"share",void 0),te(this,"tracking",void 0),e.settings&&(this.allowAnswerChange=!!e.settings.allowAnswerChange,this.tracking=e.settings.tracking,e.settings.hideMessageAfterDelay&&(this.hideMessageAfterDelay=e.settings.hideMessageAfterDelay),e.settings.share&&(this.share=e.settings.share,!this.share.imageUrl&&me.getConfig("share")&&me.getConfig("share").defaultImgUrl&&(this.share.imageUrl=me.getConfig("share").defaultImgUrl)))}}function ie(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class re{constructor(e){ie(this,"liveTitle","Live"),ie(this,"chatTitle","Chat"),ie(this,"logoUrl",""),ie(this,"headerText",""),e.tabs&&(e.tabs.liveTitle&&(this.liveTitle=e.tabs.liveTitle),e.tabs.chatTitle&&(this.chatTitle=e.tabs.chatTitle),e.tabs.logoUrl&&(this.logoUrl=me.getConfig("backend").api+me.getConfig("backend").imagesUrl+"/"+e.tabs.logoUrl),e.tabs.headerText&&(this.headerText=e.tabs.headerText))}}function ne(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class ae{constructor(e,t){ne(this,"answerBackgroundColor",""),ne(this,"answerBorderColor",""),ne(this,"answerColor",""),ne(this,"backgroundBrightness",""),ne(this,"backgroundColor",""),ne(this,"backgroundImageBlur",""),ne(this,"backgroundImageFile",""),ne(this,"backgroundImagePosition",""),ne(this,"buttonColor",""),ne(this,"font",""),ne(this,"questionColor",""),ne(this,"customThemeCssFile",""),ne(this,"backgroundImageConvertedFile",""),ne(this,"tabBorderColor",""),ne(this,"tabFontColor",""),ne(this,"tabColor",""),ne(this,"embedSettings",void 0),this.embedSettings=t,e.theme&&(this.answerBackgroundColor=e.theme.answerBackgroundColor||"",this.answerBorderColor=e.theme.answerBorderColor||"",this.answerColor=e.theme.answerColor||"",this.backgroundBrightness=e.theme.backgroundBrightness||"",this.backgroundColor=e.theme.backgroundColor||"",this.backgroundImageBlur=e.theme.backgroundImageBlur||"",this.backgroundImageFile=e.theme.backgroundImageFile||"",this.backgroundImagePosition=e.theme.backgroundImagePosition||"",this.buttonColor=e.theme.buttonColor||"",this.font=e.theme.font||"",this.questionColor=e.theme.questionColor||"",this.tabColor=e.theme.tabColor||"",this.tabFontColor=e.theme.tabFontColor||"",this.tabBorderColor=e.theme.tabBorderColor||"",e.theme.customThemeCssFile&&(this.customThemeCssFile=me.config.backend.api+"/uploads/"+e.theme.customThemeCssFile),e.theme.backgroundImageFile&&this.convertBackgroundImage())}convertBackgroundImage(){this.backgroundImageConvertedFile=me.cloudinary.prepareBackgroundImageUrl(this.backgroundImageFile,window.innerWidth,"auto"===this.embedSettings.height?null:window.innerHeight,parseInt(this.backgroundImageBlur,10),this.backgroundImagePosition)}}function oe(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class le{get id(){return this._engageformId}get pages(){return this._pages}get startPages(){return this._startPages}get endPages(){return this._endPages}get availablePages(){return this._availablePages}get typeName(){return l[this.type].toLowerCase()}get hasForms(){return this._hasForms}getPageById(e){return this.pages[e]}getPageByIndex(e){return this.pages[this.availablePages[e]]}getPageIndex(e){return this.availablePages.indexOf(e.id)}isType(e){return this.type===e}isNormalMode(){return Boolean(this.mode===o.Default||this.mode===o.Preview)}isSummaryMode(){return Boolean(this.mode===o.Summary)}isResultsMode(){return Boolean(this.mode===o.Result)}isPreviewMode(){return Boolean(this.mode===o.Preview)}constructor(e,t,s,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:()=>{};oe(this,"_engageformId",void 0),oe(this,"_pages",{}),oe(this,"_startPages",[]),oe(this,"_endPages",[]),oe(this,"_availablePages",[]),oe(this,"_hasForms",!1),oe(this,"sendAnswerCallback",void 0),oe(this,"enabled",!0),oe(this,"type",l.Undefined),oe(this,"title",void 0),oe(this,"message",void 0),oe(this,"settings",void 0),oe(this,"theme",void 0),oe(this,"branding",void 0),oe(this,"tabs",void 0),oe(this,"themeType",void 0),oe(this,"embedSettings",void 0),oe(this,"texts",void 0),oe(this,"current",void 0),oe(this,"navigation",void 0),oe(this,"meta",void 0),oe(this,"answers",new Map),oe(this,"event",void 0),oe(this,"mode",void 0),this._engageformId=e._id,this.mode=t,this.embedSettings=i,this.sendAnswerCallback=r,this.title=e.title,this.settings=new se(e),this.theme=new ae(e,i),this.tabs=new re(e),this.texts=e.texts,this.themeType=this.getThemeType(e.theme.backgroundColor),this.event=new x,this.branding=I.create(e.settings&&e.settings.branding);let n=this.buildPages(s||[],this.settings);n.forEach(e=>this.storePage(e)),this._hasForms=n.some(e=>e.type===v.Form);const a=Boolean(e._logic);this.navigation=a?C.fromEnageformAndData(this,e):b.fromEnageform(this),this.meta=O.fromEngageform(this)}setUserIdent(e){me.user.sessionId=e}getUserIdent(e){return me.user.sessionId}storePage(e){return e.type===v.StartPage?this.isNormalMode()&&this._startPages.push(e.id):e.type===v.EndPage?this.isNormalMode()&&this._endPages.push(e.id):this._availablePages.push(e.id),this._pages[e.id]=e,e}initPage(e){return this.storePage(this.buildPages([e],this.settings)[0]),this.setCurrent(e._id)}setCurrent(e){let t=this._pages[e];return this.current=t,t}setCurrentEndPage(){var e=me.config.backend.domain+me.getConfig("engageform").engageformFinishUrl;return e=e.replace(":engageformId",this._engageformId),me.mode!==o.Default&&(e+="?preview"),me.$http.post(e,{userIdent:me.user.sessionId,globalUserIdent:me.user.id}).then(e=>-1!==[200,304].indexOf(e.status)?(me.localStorage.clearAll(),me.user.id=e.data.globalUserIdent,e.data):me.$q.reject(e))}cleanPages(){this._availablePages.length=0,this._pages={}}buildPages(e,t){return e.map(e=>this.createPage(e,t)).filter(e=>Boolean(e))}createPage(e,t){switch(e.type){case v.EndPage:return new j(this,e,t);case v.Form:return new $(this,e);case v.MultiChoice:return new N(this,e);case v.PictureChoice:return new z(this,e);case v.Rateit:return new J(this,e);case v.StartPage:return new Y(this,e);case v.Poster:return new H(this,e);default:throw new Error("Trying to construct an unknown page.")}}setSummary(e){e.forEach(e=>{e.stats&&this._pages[e.stats.questionId]&&this._pages[e.stats.questionId].setResults(e)})}setAnswers(e){let t=e.questions;for(let e in t)if(this._pages[e]){let s=t[e];this._pages[e].selectAnswer({selectedCaseId:s.selectedAnswerId,inputs:s.inputs,selectedValue:s.rateItValue})}}setResultPage(e){const t={_id:"summaryPage",type:v.SummaryPage,settings:{showCorrectAnswer:!0},stats:e},s=new ee(this,t);this.storePage(s)}setUserResultPage(e){const t={_id:"RESULT_PAGE",type:"summaryPage",settings:{}};"outcome"===e.type?Object(i.extend)(t,{text:"User's outcome: "+e.outcome}):Object(i.extend)(t,{text:"User's score: "+e.score+" / "+e.maxScore});const s=new ee(this,t);this.storePage(s)}setAnswer(e,t){const s=Object(i.get)(t,"selectedCaseId")||Object(i.get)(t,"selectedValue")||t;this.answers.set(e,s)}getThemeType(e){const t=this.colorToRgb(e);return.299*t.red+.587*t.green+.114*t.blue>186?"light":"dark"}colorToRgb(e){let t;if("#"===e[0])e=e.substr(1);else{const t=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);e=t&&4===t.length?("0"+parseInt(t[1],10).toString(16)).slice(-2)+("0"+parseInt(t[2],10).toString(16)).slice(-2)+("0"+parseInt(t[3],10).toString(16)).slice(-2):""}if(3===e.length){let t=e;e="",t=(t=/^([a-f0-9])([a-f0-9])([a-f0-9])$/i.exec(t)).slice(1);for(let s=0;s<3;s++)e+=t[s]+t[s]}if(!(t=/^([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i.exec(e)))throw new Error("Invalid color.");return t=t.slice(1),{red:parseInt(t[0],16),green:parseInt(t[1],16),blue:parseInt(t[2],16)}}}function he(e,t){return Object(i.includes)(Object(i.values)(e),t)}function ge(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class ue{static create(){return new ue}get id(){return this._id||(this._id=me.localStorage.get(ue.idKey)),this._id}set id(e){me.localStorage.set(ue.idKey,e),this._id=e}get sessionId(){return this._sessionId||(this._sessionId=me.localStorage.get(ue.sessionIdKey)),this._sessionId}set sessionId(e){me.localStorage.set(ue.sessionIdKey,e),this._sessionId=e}constructor(){ge(this,"_id",null),ge(this,"_sessionId",null)}}function ce(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var s=[],i=!0,r=!1,n=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done)&&(s.push(a.value),!t||s.length!==t);i=!0);}catch(e){r=!0,n=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw n}}return s}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function de(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}ge(ue,"idKey","userIdent"),ge(ue,"sessionIdKey","sessionIdent"),s.d(t,"default",function(){return me});class me{static getConfig(e){return me.config[e]}constructor(e,t,s,i,r,n){de(this,"_engageform",void 0),de(this,"_event",void 0),me.$http=e,me.$q=t,me.$timeout=s,me.cloudinary=i,me.localStorage=r,me.config=n,this._event=new x,me.cloudinary.setConfig(n.cloudinary)}get type(){return this._engageform?this._engageform.type:l.Undefined}get Type(){return l}get mode(){return me.mode}get Mode(){return o}get title(){if(this._engageform)return this._engageform.title}get theme(){if(this._engageform)return this._engageform.theme}get current(){if(this._engageform)return this._engageform.current}get navigation(){if(this._engageform)return this._engageform.navigation}get branding(){if(this._engageform)return this._engageform.branding}get message(){if(this._engageform)return this._engageform.message}get meta(){if(this._engageform)return this._engageform.meta}get event(){if(this._event)return this._event}init(e){const t=Object(i.defaults)({},e,{mode:o.Default});if(!t||!t.id)return me.$q.reject({status:"error",error:{code:406,message:"The required id property does not exist."},data:t});if(me._instances[t.id])return me._instances[t.id];if(!he(o,t.mode))return me.$q.reject({status:"error",error:{code:406,message:"Mode property not supported."},data:t});me.mode=t.mode;let s=[me.getData("quiz",t.id),t.live?me.$q.resolve([]):me.getData("pages",t.id)];return me.$q.all(s).then(e=>{let s=ce(e,2),i=s[0],n=s[1];return he(r,i.type)?(this._engageform=new me.quizzesConstructors[i.type](i,me.mode,n,t.embedSettings,t.callback?t.callback.sendAnswerCallback:()=>{}),this._engageform):me.$q.reject({status:"error",error:{code:406,message:"Type property not supported."},data:i})})}static getData(e,t){if("quiz"!==e&&"pages"!==e)throw new Error(`Resource path for ${e} type of data is unknown.`);let s=me.getConfig("backend").domain+("quiz"===e?me.getConfig("engageform").engageformUrl:me.getConfig("engageform").engageformPagesUrl);return s=s.replace(":engageformId",t),me.mode!==o.Default&&(s+="?preview"),me.$http.get(s).then(e=>-1!==[200,304].indexOf(e.status)?e.data:me.$q.reject(e))}destroyInstances(){me._instances={}}}de(me,"user",ue.create()),de(me,"$http",void 0),de(me,"$q",void 0),de(me,"$timeout",void 0),de(me,"cloudinary",void 0),de(me,"localStorage",void 0),de(me,"config",void 0),de(me,"mode",o.Undefined),de(me,"_instances",{}),de(me,"quizzesConstructors",{outcome:class extends le{constructor(){var e,t,s;super(...arguments),e=this,t="type",s=l.Outcome,t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}setCurrentEndPage(){return super.setCurrentEndPage().then(e=>{let t=!1;return this.endPages.map(s=>{this.pages[s].outcome===e.outcome&&(t=!0,this.setCurrent(s))}),t||(this.enabled=!1,this.message="Thank you!"),e})}},poll:class extends le{constructor(){var e,t,s;super(...arguments),e=this,t="type",s=l.Poll,t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}setCurrentEndPage(){return super.setCurrentEndPage().then(e=>(this.endPages.length?this.setCurrent(this.endPages[0]):(this.enabled=!1,this.message="Thank you!"),e))}},score:class extends le{constructor(){var e,t,s;super(...arguments),e=this,t="type",s=l.Score,t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}setCurrentEndPage(){return super.setCurrentEndPage().then(e=>{let t=100,s=!1;return e.maxScore>0&&(t=Math.round(e.totalScore/e.maxScore*100)),this.endPages.map(e=>{const i=this.pages[e],r=i.rangeMin,n=void 0===r?0:r,a=i.rangeMax;n<=t&&(void 0===a?0:a)>=t&&(s=!0,i.score=t,this.setCurrent(e))}),s||(this.enabled=!1,this.message="Thank you!"),e})}},survey:class extends le{constructor(){var e,t,s;super(...arguments),e=this,t="type",s=l.Survey,t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}setCurrentEndPage(){return super.setCurrentEndPage().then(e=>(this.endPages.length?this.setCurrent(this.endPages[0]):(this.enabled=!1,this.message="Thank you!"),e))}},live:class extends le{constructor(){var e,t,s;super(...arguments),e=this,t="type",s=l.Live,t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}initPages(){const e=me.$q.defer();return e.resolve(this),e.promise}initPage(e){return this.cleanPages(),super.initPage(e)}setCurrentEndPage(){const e=me.$q.defer();return e.resolve(),e.promise}}}),me.$inject=["$http","$q","$timeout","cloudinary","localStorageService","ApiConfig"],a.service("Engageform",me)}]);